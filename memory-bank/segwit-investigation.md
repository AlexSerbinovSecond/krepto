# SegWit –ü—Ä–æ–±–ª–µ–º–∞ - –î–µ—Ç–∞–ª—å–Ω–µ –î–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è

## üö® –ö–†–ò–¢–ò–ß–ù–ê –ü–†–û–ë–õ–ï–ú–ê: SegWit –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –ë–ª–æ–∫—É—é—Ç—å –ú–∞–π–Ω—ñ–Ω–≥

**–î–∞—Ç–∞ –≤–∏—è–≤–ª–µ–Ω–Ω—è**: 27 —Ç—Ä–∞–≤–Ω—è 2025  
**–°—Ç–∞—Ç—É—Å**: üîç –ê–ö–¢–ò–í–ù–ï –î–û–°–õ–Ü–î–ñ–ï–ù–ù–Ø  
**–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç**: –ù–ê–ô–í–ò–©–ò–ô

## üéØ –ö–†–ò–¢–ò–ß–ù–ï –í–Ü–î–ö–†–ò–¢–¢–Ø: SegWit –ê–∫—Ç–∏–≤–Ω–∏–π –ó –ë–ª–æ–∫—É 481824

**–ó–ù–ê–ô–î–ï–ù–ê –ü–†–ò–ß–ò–ù–ê –ü–†–û–ë–õ–ï–ú–ò**:
- –í `src/kernel/chainparams.cpp` —Ä—è–¥–æ–∫ 96: `consensus.SegwitHeight = 481824;`
- Krepto –∑–∞—Ä–∞–∑ –Ω–∞ –±–ª–æ—Ü—ñ **2101**, —â–æ –æ–∑–Ω–∞—á–∞—î SegWit –∞–∫—Ç–∏–≤–Ω–∏–π –∑ —Å–∞–º–æ–≥–æ –ø–æ—á–∞—Ç–∫—É!
- –¶–µ –ø–æ—è—Å–Ω—é—î, —á–æ–º—É SegWit —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –∑'—è–≤–ª—è—é—Ç—å—Å—è –≤ mempool

### –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ Bitcoin Core
**Stack Overflow –ø—Ä–æ–±–ª–µ–º–∞**: –†—ñ–∑–Ω—ñ –≤–µ—Ä—Å—ñ—ó Bitcoin Core –º–∞–ª–∏ —Ä—ñ–∑–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è SegWit –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó
- v0.14.3: SegWit —Å—Ç–∞—Ç—É—Å "defined" (–Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π)
- v0.16.3: SegWit —Å—Ç–∞—Ç—É—Å "active" (–∞–∫—Ç–∏–≤–Ω–∏–π)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: `unexpected-witness, ContextualCheckBlock : unexpected witness data found (code 16)`

### –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –¥–æ Krepto
**–ù–ê–®–ê –°–ò–¢–£–ê–¶–Ü–Ø**:
- SegWit –∞–∫—Ç–∏–≤–Ω–∏–π –∑ –±–ª–æ–∫—É 481824 (Bitcoin mainnet –∑–Ω–∞—á–µ–Ω–Ω—è)
- –ü–æ—Ç–æ—á–Ω–∏–π –±–ª–æ–∫: 2101 (–Ω–∞–±–∞–≥–∞—Ç–æ –º–µ–Ω—à–µ –∑–∞ 481824)
- **–ü–ê–†–ê–î–û–ö–°**: SegWit –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ –ù–ï–∞–∫—Ç–∏–≤–Ω–∏–π, –∞–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –≤—Å–µ –æ–¥–Ω–æ —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è

## –û–ø–∏—Å –ü—Ä–æ–±–ª–µ–º–∏

### –û—Å–Ω–æ–≤–Ω–∞ –ü—Ä–æ–±–ª–µ–º–∞
–ü—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è SegWit —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –≤ GUI –≥–∞–º–∞–Ω—Ü—ñ Krepto –º–∞–π–Ω—ñ–Ω–≥ –ø–æ–≤–Ω—ñ—Å—Ç—é –ø—Ä–∏–ø–∏–Ω—è—î—Ç—å—Å—è –∑ –ø–æ–º–∏–ª–∫–æ—é:
```
CreateNewBlock: TestBlockValidity failed: unexpected-witness, CheckWitnessMalleation : unexpected witness data found
```

### –ü–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –ü–æ–¥—ñ–π
1. **–ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∞–Ω**: –ú–∞–π–Ω—ñ–Ω–≥ –ø—Ä–∞—Ü—é—î –Ω–æ—Ä–º–∞–ª—å–Ω–æ
2. **–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ä–æ–±–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é**: –ß–µ—Ä–µ–∑ GUI –≥–∞–º–∞–Ω–µ—Ü—å (–Ω–∞–≤—ñ—Ç—å –∑—ñ —Å–≤–æ—î—ó –∞–¥—Ä–µ—Å–∏ –Ω–∞ —Å–≤–æ—é)
3. **–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –ø–æ—Ç—Ä–∞–ø–ª—è—î –≤ mempool**: –ó SegWit witness data
4. **–ú–∞–π–Ω—ñ–Ω–≥ –±–ª–æ–∫—É—î—Ç—å—Å—è**: `generatetoaddress` –ø–æ–≤–µ—Ä—Ç–∞—î –ø–æ–º–∏–ª–∫—É
5. **–ü—Ä–æ–±–ª–µ–º–∞ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è**: –ù–∞–≤—ñ—Ç—å –ø—ñ—Å–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É –Ω–æ–¥–∏

## –¢–µ—Ö–Ω—ñ—á–Ω—ñ –î–µ—Ç–∞–ª—ñ

### –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –ü—Ä–æ–±–ª–µ–º–Ω–æ—ó –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
```json
{
  "txid": "4a8353e4a06e4217c78928b8ce27a452daff4ffe972d28aacba96c5d6d617b0e",
  "hash": "db6b7c9cabea8b8e57b2c949ad31b1323dbb0cae79f2a46da85cf1926ec2c7ba",
  "version": 2,
  "size": 222,
  "vsize": 141,
  "weight": 561,
  "txinwitness": [
    "3044022053defdc2c212acbbee066cfafd752fc3afea9b7eeaaf214bc302e987fb80dedb022023973a5ffc997623b8b24657233fbd53887d2ec67eefcfa826e12466a278dc0401",
    "02f97fe81ffcb648a45953d8b52d1d63b492de2aec47df91854b36bc4eb7c66674"
  ],
  "vout": [
    {
      "address": "kr1qprhfhmk2y4uyumwrx0jdjhapzeuhr7fnzj78fz",
      "type": "witness_v0_keyhash"
    }
  ]
}
```

### –ö–ª—é—á–æ–≤—ñ –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏ SegWit
- **weight** (561) > **vsize * 4** (141 * 4 = 564) - –æ–∑–Ω–∞–∫–∞ SegWit
- **–ê–¥—Ä–µ—Å–∏ —Ç–∏–ø—É kr1q...** (bech32 format)
- **–ù–∞—è–≤–Ω—ñ—Å—Ç—å txinwitness** –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
- **type: "witness_v0_keyhash"** –≤ outputs

### –ü–æ–≤–µ–¥—ñ–Ω–∫–∞ –ü—Ä–æ–±–ª–µ–º–∏
1. **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å**: –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –≤ mempool –Ω–∞–≤—ñ—Ç—å –ø—ñ—Å–ª—è:
   - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫—É –Ω–æ–¥–∏
   - –í–∏–¥–∞–ª–µ–Ω–Ω—è `mempool.dat`
   - –ó–∞–ø—É—Å–∫—É –∑ `-persistmempool=0`
   - –ó–∞–ø—É—Å–∫—É –∑ `-connect=0` (–±–µ–∑ –º–µ—Ä–µ–∂–µ–≤–∏—Ö –∑'—î–¥–Ω–∞–Ω—å)

2. **–î–∂–µ—Ä–µ–ª–æ**: –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –Ω–∞–¥—Ö–æ–¥–∏—Ç—å –∑ –≥–∞–º–∞–Ω—Ü—è, –∞ –Ω–µ –∑ –º–µ—Ä–µ–∂—ñ

3. **–Ñ–¥–∏–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è**: –ó–∞–ø—É—Å–∫ –∑ `-disablewallet` –æ—á–∏—â–∞—î mempool

## –ü—Ä–æ–≤–µ–¥–µ–Ω—ñ –ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏

### –ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç #1: –í—ñ–¥–∫–∞—Ç –ë–ª–æ–∫—á–µ–π–Ω—É
**–ú–µ—Ç–∞**: –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤'—è–∑–∞–Ω–∞ –∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–º –±–ª–æ–∫–æ–º

**–ö—Ä–æ–∫–∏**:
1. –í—ñ–¥–∫–∞—Ç –∑ –±–ª–æ–∫—É 8279 –¥–æ 8179 - –ø—Ä–æ–±–ª–µ–º–∞ –∑–∞–ª–∏—à–∏–ª–∞—Å—è
2. –í—ñ–¥–∫–∞—Ç –¥–æ –±–ª–æ–∫—É 2200 - –ø—Ä–æ–±–ª–µ–º–∞ –∑–∞–ª–∏—à–∏–ª–∞—Å—è  
3. –í—ñ–¥–∫–∞—Ç –¥–æ –±–ª–æ–∫—É 2100 - –ø—Ä–æ–±–ª–µ–º–∞ –∑–∞–ª–∏—à–∏–ª–∞—Å—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ –ø–æ–≤'—è–∑–∞–Ω–∞ –∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–º –±–ª–æ–∫–æ–º

### –ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç #2: –û—á–∏—â–µ–Ω–Ω—è Mempool
**–ú–µ—Ç–∞**: –í–∏–¥–∞–ª–∏—Ç–∏ –ø—Ä–æ–±–ª–µ–º–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é –∑ mempool

**–°–ø—Ä–æ–±–∏**:
```bash
# –°–ø—Ä–æ–±–∞ 1: –í–∏–¥–∞–ª–µ–Ω–Ω—è —Ñ–∞–π–ª—É mempool
rm -f /Users/serbinov/.krepto/mempool.dat
# –†–µ–∑—É–ª—å—Ç–∞—Ç: –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –ø—ñ—Å–ª—è –∑–∞–ø—É—Å–∫—É

# –°–ø—Ä–æ–±–∞ 2: –ó–∞–ø—É—Å–∫ –±–µ–∑ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è mempool
./src/bitcoind -persistmempool=0
# –†–µ–∑—É–ª—å—Ç–∞—Ç: –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è

# –°–ø—Ä–æ–±–∞ 3: –Ü–∑–æ–ª—è—Ü—ñ—è –≤—ñ–¥ –º–µ—Ä–µ–∂—ñ
./src/bitcoind -connect=0 -persistmempool=0
# –†–µ–∑—É–ª—å—Ç–∞—Ç: –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è

# –°–ø—Ä–æ–±–∞ 4: –í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≥–∞–º–∞–Ω—Ü—è
./src/bitcoind -disablewallet
# –†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ Mempool –ø–æ—Ä–æ–∂–Ω—ñ–π!
```

**–í–∏—Å–Ω–æ–≤–æ–∫**: –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –Ω–∞–¥—Ö–æ–¥–∏—Ç—å –∑ –≥–∞–º–∞–Ω—Ü—è, –∞ –Ω–µ –∑ –º–µ—Ä–µ–∂—ñ

### –ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç #3: –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ú–∞–π–Ω—ñ–Ω–≥—É
**–ú–µ—Ç–∞**: –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä–æ–±–æ—Ç—É –º–∞–π–Ω—ñ–Ω–≥—É –≤ —Ä—ñ–∑–Ω–∏—Ö —É–º–æ–≤–∞—Ö

**–†–µ–∑—É–ª—å—Ç–∞—Ç–∏**:
- **–ó SegWit –≤ mempool**: ‚ùå `unexpected-witness` –ø–æ–º–∏–ª–∫–∞
- **–ë–µ–∑ –≥–∞–º–∞–Ω—Ü—è (mempool –ø–æ—Ä–æ–∂–Ω—ñ–π)**: ‚ùå –ü–æ–≤–µ—Ä—Ç–∞—î –ø–æ—Ä–æ–∂–Ω—ñ–π –º–∞—Å–∏–≤ `[]`
- **–ó legacy –∞–¥—Ä–µ—Å–∞–º–∏**: ‚úÖ –ü—Ä–∞—Ü—é—î (–∫–æ–ª–∏ –Ω–µ–º–∞—î SegWit –≤ mempool)

## –ì—ñ–ø–æ—Ç–µ–∑–∏ —Ç–∞ –î–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è

### –ì—ñ–ø–æ—Ç–µ–∑–∞ #1: CheckWitnessMalleation –ö–æ–Ω—Ñ–ª—ñ–∫—Ç
**–¢–µ–æ—Ä—ñ—è**: –§—É–Ω–∫—Ü—ñ—è `CheckWitnessMalleation` –≤ Krepto –Ω–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–æ–±–ª—è—î SegWit —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó

**–ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ—Å–ª—ñ–¥–∏—Ç–∏**:
- –ó–Ω–∞–π—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é `CheckWitnessMalleation` –≤ –∫–æ–¥—ñ
- –ü–æ—Ä—ñ–≤–Ω—è—Ç–∏ –∑ Bitcoin Core —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—î—é
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è SegWit –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –≤ chainparams.cpp

### –ì—ñ–ø–æ—Ç–µ–∑–∞ #2: SegWit –ù–µ –ê–∫—Ç–∏–≤–æ–≤–∞–Ω–∏–π –ü—Ä–∞–≤–∏–ª—å–Ω–æ
**–¢–µ–æ—Ä—ñ—è**: SegWit –Ω–µ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∏–π –≤ –º–µ—Ä–µ–∂—ñ Krepto, –∞–ª–µ GUI —Å—Ç–≤–æ—Ä—é—î SegWit —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó

**–ü–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏**:
- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è SegWit –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –≤ consensus –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö
- –ß–∏ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∏–π SegWit –Ω–∞ –ø–æ—Ç–æ—á–Ω—ñ–π –≤–∏—Å–æ—Ç—ñ –±–ª–æ–∫—ñ–≤
- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è GUI –¥–ª—è —Ç–∏–ø—É –∞–¥—Ä–µ—Å

### –ì—ñ–ø–æ—Ç–µ–∑–∞ #3: GUI –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
**–¢–µ–æ—Ä—ñ—è**: GUI –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —Å—Ç–≤–æ—Ä—é—î SegWit –∞–¥—Ä–µ—Å–∏, —è–∫—ñ –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è

**–ü–æ—Ç—Ä—ñ–±–Ω–æ –∑–º—ñ–Ω–∏—Ç–∏**:
- –¢–∏–ø –∞–¥—Ä–µ—Å –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≤ GUI –Ω–∞ legacy
- –î–æ–¥–∞—Ç–∏ –æ–ø—Ü—ñ—é –≤–∏–±–æ—Ä—É —Ç–∏–ø—É –∞–¥—Ä–µ—Å–∏
- –ó–∞–±–æ—Ä–æ–Ω–∏—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è SegWit —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π

## –ê–ª–≥–æ—Ä–∏—Ç–º–∏ –í–∏—Ä—ñ—à–µ–Ω–Ω—è

### üîß –ê–õ–ì–û–†–ò–¢–ú #1: –í–∏–¥–∞–ª–µ–Ω–Ω—è –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –∑ Mempool

#### –ú–µ—Ç–æ–¥ 1: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–µ–∑ Mempool
```bash
./src/bitcoin-cli stop
rm -f /Users/serbinov/.krepto/mempool.dat
./src/bitcoind -datadir=/Users/serbinov/.krepto -daemon -persistmempool=0
./src/bitcoin-cli getmempoolinfo
```

#### –ú–µ—Ç–æ–¥ 2: –Ü–∑–æ–ª—è—Ü—ñ—è –≤—ñ–¥ –ú–µ—Ä–µ–∂—ñ
```bash
./src/bitcoin-cli stop
./src/bitcoind -datadir=/Users/serbinov/.krepto -daemon -connect=0 -persistmempool=0
./src/bitcoin-cli getmempoolinfo
```

#### –ú–µ—Ç–æ–¥ 3: –í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –ì–∞–º–∞–Ω—Ü—è (–ü–†–ê–¶–Æ–Ñ)
```bash
./src/bitcoin-cli stop
./src/bitcoind -datadir=/Users/serbinov/.krepto -daemon -disablewallet -persistmempool=0
./src/bitcoin-cli getmempoolinfo  # –ü–æ–≤–∏–Ω–µ–Ω –ø–æ–∫–∞–∑–∞—Ç–∏ size: 0
```

#### –ú–µ—Ç–æ–¥ 4: –†–µ–∑–µ—Ä–≤–Ω–µ –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –ì–∞–º–∞–Ω—Ü—è
```bash
./src/bitcoin-cli stop
mv /Users/serbinov/.krepto/wallets /Users/serbinov/.krepto/wallets_backup
rm -f /Users/serbinov/.krepto/mempool.dat
./src/bitcoind -datadir=/Users/serbinov/.krepto -daemon
```

### üîß –ê–õ–ì–û–†–ò–¢–ú #2: –í—ñ–¥–∫–∞—Ç –¥–æ –ü–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ë–ª–æ–∫—É

#### –ú–µ—Ç–æ–¥ 1: –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è invalidateblock
```bash
# –û—Ç—Ä–∏–º–∞—Ç–∏ —Ö–µ—à –±–ª–æ–∫—É –¥–ª—è —ñ–Ω–≤–∞–ª—ñ–¥–∞—Ü—ñ—ó
target_height=2100
invalid_height=$((target_height + 1))
invalid_hash=$(./src/bitcoin-cli getblockhash $invalid_height)

# –Ü–Ω–≤–∞–ª—ñ–¥—É–≤–∞—Ç–∏ –±–ª–æ–∫
./src/bitcoin-cli invalidateblock $invalid_hash

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
./src/bitcoin-cli getblockchaininfo
```

#### –ú–µ—Ç–æ–¥ 2: –§—É–Ω–∫—Ü—ñ—è –í—ñ–¥–∫–∞—Ç—É
```bash
rollback_blocks() {
    local blocks_back=$1
    current_height=$(./src/bitcoin-cli getblockchaininfo | jq -r '.blocks')
    target_height=$((current_height - blocks_back))
    invalid_height=$((target_height + 1))
    invalid_hash=$(./src/bitcoin-cli getblockhash $invalid_height)
    ./src/bitcoin-cli invalidateblock $invalid_hash
    echo "Rolled back $blocks_back blocks. New height: $target_height"
}

# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
rollback_blocks 100
```

### üîß –ê–õ–ì–û–†–ò–¢–ú #3: –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ SegWit –ü—Ä–æ–±–ª–µ–º

#### –®–≤–∏–¥–∫–∞ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ mempool –Ω–∞ SegWit —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
check_segwit_in_mempool() {
    ./src/bitcoin-cli getrawmempool true | jq -r 'to_entries[] | select(.value.weight > (.value.vsize * 4)) | .key'
}

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é
check_transaction_segwit() {
    local txid=$1
    ./src/bitcoin-cli getrawtransaction $txid true | jq -r '.txinwitness // empty'
}

# –¢–µ—Å—Ç –º–∞–π–Ω—ñ–Ω–≥—É
test_mining() {
    result=$(./src/bitcoin-cli generatetoaddress 1 K9iZTbAUMnikKeQae4qwkYc8A5xpazEtTW 10000000 2>&1)
    if echo "$result" | grep -q "unexpected-witness"; then
        echo "‚ùå SegWit –ø—Ä–æ–±–ª–µ–º–∞ –≤–∏—è–≤–ª–µ–Ω–∞"
        return 1
    else
        echo "‚úÖ –ú–∞–π–Ω—ñ–Ω–≥ –ø—Ä–∞—Ü—é—î"
        return 0
    fi
}
```

#### –ü–æ–≤–Ω–∞ –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
```bash
diagnose_segwit_issue() {
    echo "üîç –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ SegWit –ø—Ä–æ–±–ª–µ–º..."
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ mempool
    mempool_size=$(./src/bitcoin-cli getmempoolinfo | jq -r '.size')
    echo "üìä Mempool size: $mempool_size"
    
    if [ $mempool_size -gt 0 ]; then
        echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ SegWit —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π..."
        segwit_txs=$(check_segwit_in_mempool)
        if [ -n "$segwit_txs" ]; then
            echo "‚ö†Ô∏è  –ó–Ω–∞–π–¥–µ–Ω–æ SegWit —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó:"
            echo "$segwit_txs"
        fi
    fi
    
    # –¢–µ—Å—Ç –º–∞–π–Ω—ñ–Ω–≥—É
    echo "üî® –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –º–∞–π–Ω—ñ–Ω–≥—É..."
    test_mining
    
    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó
    if [ $? -ne 0 ]; then
        echo "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:"
        echo "1. –û—á–∏—Å—Ç–∏—Ç–∏ mempool (–ê–ª–≥–æ—Ä–∏—Ç–º #1)"
        echo "2. –í—ñ–¥–∫–∞—Ç–∏—Ç–∏—Å—è –¥–æ –±–ª–æ–∫—É –±–µ–∑ SegWit (–ê–ª–≥–æ—Ä–∏—Ç–º #2)"
        echo "3. –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –±–µ–∑ –≥–∞–º–∞–Ω—Ü—è –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è"
    fi
}
```

## –®–≤–∏–¥–∫—ñ –ö–æ–º–∞–Ω–¥–∏

### –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ SegWit —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π –≤ mempool
./src/bitcoin-cli getrawmempool true | jq -r 'to_entries[] | select(.value.weight > (.value.vsize * 4)) | .key'

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ mempool
./src/bitcoin-cli getmempoolinfo

# –¢–µ—Å—Ç –º–∞–π–Ω—ñ–Ω–≥—É
./src/bitcoin-cli generatetoaddress 1 K9iZTbAUMnikKeQae4qwkYc8A5xpazEtTW 10000000
```

### –¢–∏–º—á–∞—Å–æ–≤–µ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è
```bash
# –®–≤–∏–¥–∫–µ –æ—á–∏—â–µ–Ω–Ω—è –¥–ª—è –º–∞–π–Ω—ñ–Ω–≥—É
quick_fix_mining() {
    ./src/bitcoin-cli stop
    sleep 3
    rm -f /Users/serbinov/.krepto/mempool.dat
    ./src/bitcoind -datadir=/Users/serbinov/.krepto -daemon -disablewallet
    sleep 5
    ./src/bitcoin-cli generatetoaddress 1 K9iZTbAUMnikKeQae4qwkYc8A5xpazEtTW 10000000
}
```

### –í—ñ–¥–∫–∞—Ç –¥–æ –ë–µ–∑–ø–µ—á–Ω–æ–≥–æ –°—Ç–∞–Ω—É
```bash
# –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –±–ª–æ–∫—É 2100
rollback_to_safe_state() {
    ./src/bitcoin-cli invalidateblock $(./src/bitcoin-cli getblockhash 2101)
    echo "Rolled back to block 2100 (safe state)"
}
```

## –ù–∞—Å—Ç—É–ø–Ω—ñ –ö—Ä–æ–∫–∏ –î–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è

### –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç #1: –î–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è –ö–æ–¥—É
1. **–ó–Ω–∞–π—Ç–∏ CheckWitnessMalleation**:
   ```bash
   grep -r "CheckWitnessMalleation" src/
   grep -r "unexpected-witness" src/
   ```

2. **–ü–æ—Ä—ñ–≤–Ω—è—Ç–∏ –∑ Bitcoin Core**:
   - –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ Bitcoin Core –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –≤–µ—Ä—Å—ñ—ó
   - –ü–æ—Ä—ñ–≤–Ω—è—Ç–∏ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—é CheckWitnessMalleation
   - –ó–Ω–∞–π—Ç–∏ –≤—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç—ñ

3. **–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ SegWit –∞–∫—Ç–∏–≤–∞—Ü—ñ—é**:
   - –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ `src/chainparams.cpp`
   - –ó–Ω–∞–π—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è SegWit consensus
   - –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤–∏—Å–æ—Ç—É –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó

### –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç #2: –ú–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—è GUI
1. **–ó–º—ñ–Ω–∏—Ç–∏ —Ç–∏–ø –∞–¥—Ä–µ—Å –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º**:
   - –ó–Ω–∞–π—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤ GUI –∫–æ–¥—ñ
   - –ó–º—ñ–Ω–∏—Ç–∏ –∑ SegWit –Ω–∞ legacy
   - –ü—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π

2. **–î–æ–¥–∞—Ç–∏ –æ–ø—Ü—ñ—é –≤–∏–±–æ—Ä—É**:
   - –°—Ç–≤–æ—Ä–∏—Ç–∏ UI –¥–ª—è –≤–∏–±–æ—Ä—É —Ç–∏–ø—É –∞–¥—Ä–µ—Å–∏
   - –î–æ–∑–≤–æ–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –æ–±–∏—Ä–∞—Ç–∏
   - –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

### –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç #3: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ñ –†—ñ—à–µ–Ω–Ω—è
1. **–í—ñ–¥–∫–ª—é—á–∏—Ç–∏ SegWit**:
   - –ú–æ–¥–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏ chainparams.cpp
   - –í–∏–¥–∞–ª–∏—Ç–∏ SegWit –∞–∫—Ç–∏–≤–∞—Ü—ñ—é
   - –ü–µ—Ä–µ–∫–æ–º–ø—ñ–ª—é–≤–∞—Ç–∏ —Ç–∞ –ø—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏

2. **–ú–æ–¥–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏ CheckWitnessMalleation**:
   - –ó–º—ñ–Ω–∏—Ç–∏ –ª–æ–≥—ñ–∫—É –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
   - –î–æ–∑–≤–æ–ª–∏—Ç–∏ SegWit —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
   - –ü—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏ –º–∞–π–Ω—ñ–Ω–≥

## –ü–æ—Ç–æ—á–Ω–∏–π –°—Ç–∞—Ç—É—Å

### –©–æ –ü—Ä–∞—Ü—é—î ‚úÖ
- ‚úÖ –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
- ‚úÖ –ê–ª–≥–æ—Ä–∏—Ç–º–∏ –≤–∏—Ä—ñ—à–µ–Ω–Ω—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤–∞–Ω–æ
- ‚úÖ –¢–∏–º—á–∞—Å–æ–≤—ñ —Ä—ñ—à–µ–Ω–Ω—è –∑–Ω–∞–π–¥–µ–Ω–æ
- ‚úÖ –ú–∞–π–Ω—ñ–Ω–≥ –ø—Ä–∞—Ü—é—î –±–µ–∑ SegWit —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π

### –©–æ –ù–µ –ü—Ä–∞—Ü—é—î ‚ùå
- ‚ùå –ú–∞–π–Ω—ñ–Ω–≥ –∑ SegWit —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è–º–∏ –≤ mempool
- ‚ùå –ù–æ—Ä–º–∞–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞ –ø—ñ—Å–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è GUI –≥–∞–º–∞–Ω—Ü—è
- ‚ùå –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º–Ω–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π

### –¢–∏–º—á–∞—Å–æ–≤—ñ –†—ñ—à–µ–Ω–Ω—è
1. **–î–ª—è –º–∞–π–Ω—ñ–Ω–≥—É**: –ó–∞–ø—É—Å–∫ –∑ `-disablewallet`
2. **–î–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è**: –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è legacy –∞–¥—Ä–µ—Å
3. **–î–ª—è –≤—ñ–¥–∫–∞—Ç—É**: –ö–æ–º–∞–Ω–¥–∞ `invalidateblock`

## –í–∏—Å–Ω–æ–≤–∫–∏

1. **–ü—Ä–æ–±–ª–µ–º–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∞**: SegWit —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –¥—ñ–π—Å–Ω–æ –±–ª–æ–∫—É—é—Ç—å –º–∞–π–Ω—ñ–Ω–≥
2. **–î–∂–µ—Ä–µ–ª–æ –∑–Ω–∞–π–¥–µ–Ω–æ**: –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –Ω–∞–¥—Ö–æ–¥—è—Ç—å –∑ –≥–∞–º–∞–Ω—Ü—è, –∞ –Ω–µ –∑ –º–µ—Ä–µ–∂—ñ
3. **–¢–∏–º—á–∞—Å–æ–≤–µ —Ä—ñ—à–µ–Ω–Ω—è —î**: –ó–∞–ø—É—Å–∫ –±–µ–∑ –≥–∞–º–∞–Ω—Ü—è –¥–æ–∑–≤–æ–ª—è—î –º–∞–π–Ω–∏—Ç–∏
4. **–ü–æ—Ç—Ä—ñ–±–Ω–µ –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è –∫–æ–¥—É**: CheckWitnessMalleation –ø–æ—Ç—Ä–µ–±—É—î –∞–Ω–∞–ª—ñ–∑—É
5. **GUI –ø–æ—Ç—Ä–µ–±—É—î –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—ó**: –ó–º—ñ–Ω–∏—Ç–∏ —Ç–∏–ø –∞–¥—Ä–µ—Å –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º

**–ù–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫**: –î–æ—Å–ª—ñ–¥–∏—Ç–∏ –∫–æ–¥ CheckWitnessMalleation —Ç–∞ –ø–æ—Ä—ñ–≤–Ω—è—Ç–∏ –∑ Bitcoin Core. 